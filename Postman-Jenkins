#Windows Batch Command in Jenkins
#powershell.exe -executionpolicy bypass -command "& '%WORKSPACE%\Jenkins_PostmanDemo.ps1'"

echo "You are in the powershell script now..."

$SourceFilePath = $env:WORKSPACE
$FilenamePostfix = "*.postman_collection.json"
$EnvironmentFile = "INTenv.json"

# Get all Postman test files
$JsonFiles = Get-ChildItem -Path $SourceFilePath -name -Filter $FilenamePostfix | Sort-Object -Property CreationTime -Descending

# Change to directory where we have NodeJs installed.  Otherwise, the 'newman' command will not be recognized. 
# You can install NPM and Newman as a user and copy the ~Roaming\npm directory in the C:\ drive.
#cd C:\Users\[username]\AppData\Roaming\npm\node_modules\newman\bin
cd /usr/local/bin/node /usr/local/bin/newman 

# Loop through the json files and execute newman to run the Postman tests
foreach ($File in $JsonFiles) {
	$collectionfilepath = "https://github.com/mvaddi19/PostmanTests/blob/master/Smoke.postman_collection.json"
	$environmentfilepath = "https://github.com/mvaddi19/PostmanTests/blob/master/INTenv.json"
	node newman run $collectionfilepath -e $environmentfilepath --disable-unicode 
}

exit $LASTEXITCODE
